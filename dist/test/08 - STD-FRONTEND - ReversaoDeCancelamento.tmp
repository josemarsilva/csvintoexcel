/* 
 * Filename : 08 - STD-FRONTEND - ReversaoDeCancelamento.sql
 * Author   : josemarsilva@inmetrics.com.br
 * Date     : 2019-02-14
 * Premissas: 
 *            * Layout obtido em 07/11/2018:
 *              - Formato: (.xlsx)
 *              - Colunas: 
 *                | Cliente    | Data da venda | Código de Autorização | 4 últimos números do cartão | Terminal | Valor da venda | Valor do cancelamento |
 *                | 1001175120 |  10/01/2018   | 133612                | 4284                        | 44440260 | R$ 225,00      | R$ 80,00              |
 *                | 1001175120 |  16/02/2018   | 764488                | 2069                        | 44440260 | R$ 395,00      | R$ 95,00              |
 *                | 1013250424 |  16/02/2018   | 136582                | 4225                        | 44440260 | R$ 245,00      | R$ 45,00              |
 *                | 1001175120 |  10/01/2018   | 106496                | 9727                        | 44443850 | R$ 100,00      | R$ 50,00              |
 *                - Domínio de valores e significado de "Cliente" (obrigatório): EC
 *                - Domínio de valores e significado de "Data da venda" (obrigatório): Data da Venda
 *                - Domínio de valores e significado de "Código de Autorização" (obrigatório): Código da autorização
 *                - Domínio de valores e significado de "4 últimos números do cartão" (não obrigatório):
 *                - Domínio de valores e significado de "Terminal" (não obrigatório): 
 *                - Domínio de valores e significado de "Valor da venda" (obrigatório): Valor da Venda
 *                - Domínio de valores e significado de "Valor do cancelamento" (obrigatório): Valor do Cancelamento
 *              - Regras:
 *                - EC's reservados para StressTest, transacionados pelo GeradorMassa ( dt_batch, nu_load_file) e cancelados pelo stress test
 *                - Partição: | 4,6,8        | Massivo            | Cancelamento/Reversao |
 *                - EC's em convivencia financeira
 *            * Fluxo de Negócio: Desfazer um cancelamento que foi solicitado. Para desfazer o cancelamento é preciso ter solicitado o cancelamento antes.
 *            * Importante que o esta planilha tem uma "carcaça" que tem títulos de colunas iniciando na linha 2 e não pode ser desrespeitado. Sera preciso exportar o resultado da query em outra planilha e depois copiar e colar a partir da celula A3
 */
 
 SELECT /*+ PARALLEL 8 */ 
        DISTINCT TO_CHAR(ct.nu_customer)             AS "Cliente",
        TO_CHAR(ct.dt_transaction,'DD/MM/YYYY')
                                                     AS "Data da venda",
        ct.nu_authorization                          AS "Código de Autorização" ,
        ''                                           AS "4 últimos números do cartão",
		''                                           AS "Terminal",
        REPLACE( REPLACE( TO_CHAR(ct.vl_transaction,  '999999999.99'), ' ', '' ), '.', ',' )
                                                     AS "Valor da venda",
        REPLACE( REPLACE( TO_CHAR(ct.vl_transaction/5,'999999999.99'), ' ', '' ), '.', ',' )
                                                     AS "Valor do cancelamento"
 FROM   TBCAPR_CAPTURED_TRANSACTION ct,
        TBPRDR_PRODUCT p,
        TBPRDR_CARD_ASSOCIATION ca,
        TBPRDR_PAYMENT_CATEGORY pc,
        TBPRDR_PAYMENT_METHOD pm,
        TBSETR_SETTLEMENT_TRANSACTION st
 WHERE  1=1 
        /* Join */ 
 AND    p.cd_product = ct.cd_product
 AND    ca.cd_card_association = p.cd_card_association
 AND    pc.cd_payment_category = p.cd_payment_category
 AND    pm.cd_payment_method = p.cd_payment_method
 AND    st.dt_batch = ct.dt_batch
 AND    st.nu_mod_customer = ct.nu_mod_customer
 AND    st.nu_customer = ct.nu_customer
 AND    st.nu_transaction_id = ct.nu_transaction_id
        /* Condition */ 
 AND    ct.dt_batch = TO_DATE('27/02/2019','DD/MM/YYYY')
 AND    ct.nu_load_file_id = 12854586 
 AND    st.vl_gross_available_amount <> st.vl_transaction_amount
 AND    p.cd_payment_category <> 2 /* 2 - Débito */
 AND    p.cd_payment_method <> 2 /* 2 - Parcelado loja */
 AND    MOD( ct.nu_customer, 10) IN ( 4,6,8 )
 AND    EXISTS
        (
          SELECT 'X' FROM PERFSTAR.PERF_CLIENTE_TRANSACAO perf WHERE  perf.nu_customer = ct.nu_customer
        )
 AND    EXISTS
        (
         SELECT 'X'
         FROM   CNV.TBCNVR_STCO_CVNC_EC sce
         WHERE  sce.nu_customer = ct.nu_customer
         AND    sce.cd_stco_cvnc = 'S'
        )
 AND    ROWNUM <= 200000
 AND    ROWNUM <= 1000 /* e-mail Nilton Amancio 22/02 */
        /* Order by */
 ORDER  BY ct.nu_customer
