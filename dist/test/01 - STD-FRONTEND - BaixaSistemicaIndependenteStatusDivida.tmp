/* 
 * Filename : 01 - STD-FRONTEND - BaixaSistemicaIndependenteStatusDivida.sql
 * Author   : josemarsilva@inmetrics.com.br
 * Date     : 2019-02-14
 * Premissas: 
 *            * Layout obtido em 07/11/2018:
 *              - Formato: (.xls)
 *              - Colunas: "Número do Cliente", "Solicitante", "Tipo de arquivo", "Data prevista de liquidação", "Bandeira", "Banco", "Valor", "Motivo da Baixa"
 *              - Regras:
 *                - EC's reservados para StressTest, transacionados pelo GeradorMassa ( dt_batch, nu_load_file)
 *              - Exemplo de massa:
 *                Número do Cliente | Solicitante | Tipo de arquivo | Data prevista de liquidação | Bandeira | Banco | Valor    | Motivo da Baixa |
 *                2003012081        | 1              | D               | 20180613                    | 1        | 1     | 3.251,44 | 1               |
 *              - Domínio de valores e significado de "Solicitante" (obrigatório): 1 - Regularizações; 2 - Cobrança
 *              - Domínio de valores e sifnificado de "Tipo de Arquivo" (obrigatório se solicitante = 1; Fixo "D"): C - Crédito; E - Débito ; D - Débito ao EC ; A - ARV ; T - ARV TED;
 *              - Domínio de valores e sifnificado de "Data Previsata liquidacao" (obrigatório se solicitante = 1; formato AAAAMMDD )
 *              - Domínio de valores e sifnificado de "Bandeira" (obrigatório se solicitante = 1): 1 = VISA; 2 = MASTERCARD; 7 = ELO; 9 = DINERS; 3 = AMEX; 40 = HIPERCARD; 23 = CABAL; 6 = SOROCRED; 15 = BANESCARD; 29 = CREDSYSTEM;
 *              - Domínio de valores e sifnificado de "Banco" (obrigatório se solicitante = 1): 1=BRASIL; ...
 *              - Domínio de valores e sifnificado de "Motivo da Baixa" (obrigatório se solicitante = 1): 1 – PCLD (usar sempre esse); 2 – Jurídico; 3 - Erro do Banco - Saldo Débito; 4 - Erro do Banco - Saldo Crédito; 5 - Receita; 6 - Pagamento OP; 7 - Retorno para a agenda; 8 - Compensação; 9 - Erro do Banco - ARV; 10 - Jurídico - ARV; 11 - Pagamento OP - ARV; 12 - Receita - ARV; 13 - Retorno para a agenda – ARV;
 *            * Fluxo de negócio: representa um cliente que tem um saldo devedor contra a Cielo e este saldo é baixado (reduzido) com lançamentos de "baixa sistêmica"
 *            * Premissas:
 *              - Cliente de performance para não estragar massa de outros
 *              - Clientes em "debit balance", isto é que tenham saldo devedor em favor da Cielo. Para fazê-lo ficar devedor são feitos ajustes negativos.
 *              - Campo "Valor" pode ser preenchido com o saldo em debit balance ou um valor menor o permitindo mais de um lançamento de baixa sistemica
 *              - Condicao de Debit Balance em ARV STAR.TBSETR_SUMMARY_FUTURE_ENTRY.cd_moviment_status = 3 AND SUM( vl_total_net_amount ) < 0
 *              - Query refeita em 26/02 após esclarecimentos com Eder Ribeiro/Stefanini
 */
 
 SELECT *
 FROM
        (
          SELECT /*+ PARALLEL 4 */
                 TO_CHAR(me.nu_customer)                AS "Numero do Cliente",
                 '1'                                    AS "Solicitante",
                 'D'                                    AS "Tipo de arquivo",
                 TO_CHAR(me.dt_settlement,'YYYYMMDD')
                                                        AS "Data prevista de liquidacao",
                 TO_CHAR(me.cd_product)                 AS "Bandeira",
                 TO_CHAR(mb.cd_bank)                    AS "Banco",
                 REPLACE( TO_CHAR( ABS(SUM(me.vl_movement_net)), '999999999999,99'), ' ', '' )
                                                        AS "Valor",
                 '1'                                    AS "Motivo da Baixa"
          FROM   TBSETR_MOVEMENT_EXCEPTION me
          INNER  JOIN TBSETR_RETENTION_CONTROL rc
          ON     rc.nu_customer = me.nu_customer
          AND    rc.cd_product = me.cd_product
          AND    rc.dt_retention_end IS NULL
          AND    me.dt_settlement >= rc.dt_retention_begin
          INNER  JOIN TBCTMR_CONFIG_PMT_MERCHANT cpm
          ON     cpm.dt_config_reference = TRUNC(SYSDATE)
          AND    cpm.nu_customer = me.nu_customer
          AND    cpm.cd_product = me.cd_product
          INNER  JOIN TBCTMR_MERCHANT_BANK mb
          ON     mb.nu_merchant_bank = cpm.nu_merchant_bank
          WHERE  1=1
                /* Join */
          GROUP  BY me.nu_customer, me.dt_settlement, me.cd_product, cd_bank
          ORDER  BY  me.dt_settlement, me.nu_customer
        )
 WHERE  1=1  
 AND    ROWNUM <= 200000
 AND    ROWNUM <= 10000 /* e-mail Nilton Amancio 22/02 */
