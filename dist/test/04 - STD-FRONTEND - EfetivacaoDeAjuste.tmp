/* 
 * Filename : 04 - STD-FRONTEND - EfetivacaoDeAjuste.sql
 * Author   : josemarsilva@inmetrics.com.br
 * Date     : 2019-02-14
 * Premissas: 
 *            * Layout obtido em 07/11/2018:
 *              - Formato: (.csv)
 *              - Colunas: "DEPTO", "COD.AJUSTE", "AUTORIZACAO", "ESTABELECIMENTO", "NUMERO DO RO", "NRO.CARTAO", "DATA DA VENDA", "VALOR DO AJUSTE", "TIPO CARTAO", "TIPO DE COMISSAO", "BANDEIRA", "MOTIVO", "MEMORIA DE CALCULO"
 *              - Regras:
 *                - EC's reservados para StressTest, transacionados pelo GeradorMassa ( dt_batch, nu_load_file)
 *                - Partição: | 3,5,7,9   | Massivo            | Ajustes Financeiros   |
 *              - Exemplo de massa:
 *                | DEPTO | COD.AJUSTE | AUTORIZACAO | ESTABELECIMENTO |  NUMERO DO RO | NRO.CARTAO | DATA DA VENDA | VALOR DO AJUSTE | TIPO CARTAO | TIPO DE COMISSAO | BANDEIRA     | MOTIVO | MEMORIA DE CALCULO |
 *                | BCK   | D063       | 2004196445  | 21042018        |               |            | 21042018      | 51,1            | 164         |                  | HIPERCARD CA | AUT    | CONV               |
 *                | BCK   | D118       | 2004196453  | 21042018        |               |            | 21042018      | 51,2            | 164         |                  | HIPERCARD CA | AUT    | CONV               |
 *                | BCK   | D964       | 2004196577  | 21042018        |               |            | 21042018      | 51,3            | 164         |                  | HIPERCARD CA | AUT    | CONV               |
 *                | BCK   | D977       | 2004196585  | 21042018        |               |            | 21042018      | 51,4            | 164         |                  | HIPERCARD CA | AUT    | CONV               |
 *                | BCK   | D063       | 2004196445  | 21042018        |               |            | 21042018      | 52,1            | 164         |                  | HIPERCARD CA | AUT    | CONV               |
 *                | BCK   | D118       | 2004196453  | 21042018        |               |            | 21042018      | 52,2            | 164         |                  | HIPERCARD CA | AUT    | CONV               |
 *                | BCK   | D964       | 2004196577  | 21042018        |               |            | 21042018      | 52,3            | 164         |                  | HIPERCARD CA | AUT    | CONV               |
 *                | BCK   | D977       | 2004196585  | 21042018        |               |            | 21042018      | 52,4            | 164         |                  | HIPERCARD CA | AUT    | CONV               |
 *              - Domínio de valores e significado de "DEPTO" (obrigatório): EC
 *              - Domínio de valores e significado de "COD.AJUSTE" (obrigatório): os valores ('D145', 'D145') desobrigam da autorização do ajuste no Control Tower
 *              - Domínio de valores e significado de "AUTORIZACAO" (não obrigatório): 
 *              - Domínio de valores e significado de "ESTABELECIMENTO" (obrigatório): 
 *              - Domínio de valores e significado de "NUMERO DO RO" (não obrigatório): 
 *              - Domínio de valores e significado de "NRO.CARTAO" (não obrigatório): 
 *              - Domínio de valores e significado de "DATA DA VENDA" (obrigatório): formato DDMMYYYY
 *              - Domínio de valores e significado de "VALOR DO AJUSTE" (obrigatório): valor numérico aleatório 
 *              - Domínio de valores e significado de "TIPO CARTAO" (obrigatório): 164
 *              - Domínio de valores e significado de "TIPO DE COMISSAO" (não obrigatório): 
 *              - Domínio de valores e significado de "BANDEIRA" (não obrigatório): descritivo da bandeira
 *              - Domínio de valores e significado de "MOTIVO" (obrigatório): 
 *              - Domínio de valores e significado de "MEMORIA DE CALCULO" (não obrigatório): 
 *            * Fluxo de Negócio: Trata-se de ajuste semelhante ao que fizemos por WebService. A diferença é que no WebService nós tínhamos que ajustar uma transação chave ( Autorização + Data) específico. Neste caso não é necessário dizer a transação, apenas o cliente
 *            * Premissas:
 *              - "COD.AJUSTE" usar os valores 'D142' e 'D145' para não precisar aprovar no Control Tower, que são auto aprovados
 *              - "DATA DA VENDA" dia que eu quero que liquide o ajuste, D+1 DEBITO; D+2 CREDITO. integrado com teste de massa negativo
 *              - Foi advertido para usar os produtos que não sejam variação de produtos com "receba rápido" isto é (WHERE TBPRD_PRODUCT.cd_product < 164) 
 *              - Não funcionou com valor decimal com separador virgula, mudada a query para valores inteiros
 *              - Valor limite de até 5.000,00 porque senao exigirá uma aprovação no Control Tower
 */
 
 SELECT 'BCK'                                                   AS "DEPTO",
        DECODE( MOD(ROWNUM,2), 0, 'D142', 'D145' )
                                                                AS "COD.AJUSTE", 
        ''                                                      AS "AUTORIZACAO",
        TO_CHAR(m.nu_customer)                                  AS "ESTABELECIMENTO",
        ''                                                      AS "NUMERO DO RO",
        ''                                                      AS "NRO.CARTAO",
        TO_CHAR(TRUNC(SYSDATE) + DECODE(p.cd_payment_category, 1 /* CREDITO */, 2 /* dias */, 2 /* DEBITO */, 1/* d */, 0 /* d */) + DECODE(TO_CHAR(SYSDATE,'d'), '5' /* Qui */, 2, '6' /* Sex */, 1, 0),'DDMMYYYY')
                                                                AS "DATA DA VENDA",
        REPLACE(TO_CHAR(TRUNC(DBMS_RANDOM.VALUE(100,200),0)),' ','')
                                                                AS "VALOR DO AJUSTE",
        TO_CHAR(cpm.cd_product)                                 AS "TIPO CARTAO",
        ''                                                      AS "TIPO DE COMISSAO",
        ca.nm_card_association                                  AS "BANDEIRA",
        'STRESS TEST'                                           AS "MOTIVO",
        'CONV'                                                  AS "MEMORIA DE CALCULO"
 FROM   TBCTMR_MERCHANT m,
        TBCTMR_CONFIG_PMT_MERCHANT cpm,
        TBPRDR_PRODUCT p,
        TBPRDR_CARD_ASSOCIATION ca
 WHERE  1=1
        /* Join */ 
 AND    cpm.nu_customer = m.nu_customer
 AND    cpm.dt_config_reference = TRUNC(SYSDATE)
 AND    p.cd_product = cpm.cd_product
 AND    ca.cd_card_association = p.cd_card_association
        /* Condition */ 
 AND    EXISTS
        (
          SELECT 'X' FROM PERFSTAR.PERF_CLIENTE_TRANSACAO perf WHERE perf.nu_customer = m.nu_customer
        )
 AND    p.cd_payment_category IN ( 1 /* Credito */, 2 /* Debito */ ) 
 AND    cpm.cd_product <= 164
 AND    NOT EXISTS
        (
          SELECT 'X'
          FROM   TBCTMR_PMT_CTRCT_POT_PRICE pcpp
          WHERE  1 = 1
          AND    pcpp.dt_config_reference = dt_config_reference
          AND    pcpp.nu_customer = cpm.nu_customer
          AND    pcpp.cd_product  = cpm.cd_product
          AND    pcpp.cd_portfolio_item_category = 7 /* 7 - Receba Rapido */
        )
        /* Order by */ 
 AND    ROWNUM <= 200000
 AND    ROWNUM <= 10000 /* e-mail Nilton Amancio 22/02 */
 ORDER  BY m.nu_customer, cpm.cd_product
