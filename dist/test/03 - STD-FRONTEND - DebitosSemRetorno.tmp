/* 
 * Filename : 03 - STD-FRONTEND - DebitosSemRetorno.sql
 * Author   : josemarsilva@inmetrics.com.br
 * Date     : 2019-02-14
 * Premissas: 
 *            * Layout obtido em 07/11/2018:
 *              - Formato: (.xlsx)
 *              - Colunas: "Cliente", "Tipo Liquidação", "Banco", "Agencia", "Conta", "Valor", "Data vencimento", "Ação(Baixar, Rejeitar)", "Data de Liquidação da Baixa", "Motivo da Rejeição"
 *              - Regras:
 *                - EC's reservados para StressTest, transacionados pelo GeradorMassa ( dt_batch, nu_load_file)
 *                - EC; Obrigatório para Ação = "I" (não preencher se "E"); Cielo ou Cliente; I = Inclusão / E=exclusão;
 *              - Exemplo de massa:
 *                | Cliente    | Tipo Liquidação | Banco | Agencia | Conta            | Valor     | Data vencimento | Ação     | Data de Liquidação da Baixa | Motivo da Rejeição |
 *                | 1015110220 | Crédito         | 341   | 1       | 00000000005890-1 | R$ 251,10 | 28/02/2018      | Baixar   | 27/02/2018                  |                    |
 *                | 1015110220 | Crédito         | 341   | 1       | 00000000005890-1 | R$ 251,10 | 28/02/2018      | Rejeitar | 27/02/2018                  | Conta Inválida      |
 *              - Domínio de valores e significado de "Número do Cliente" (obrigatório): EC
 *              - Domínio de valores e significado de "Tipo Liquidação" (obrigatório): 'Crédito' ou 'Débito'
 *              - Domínio de valores e significado de "Banco" (obrigatório): codigo do banco
 *              - Domínio de valores e significado de "Agencia" (obrigatório): agencia
 *              - Domínio de valores e significado de "Conta" (obrigatório): formato <numero da conta> + '-' + <digito agencia>
 *              - Domínio de valores e significado de "Valor" (obrigatório): valor
 *              - Domínio de valores e significado de "Data vencimento" (obrigatório): data de vencimento
 *              - Domínio de valores e significado de "Ação" (obrigatório): 'Baixar' ou 'Rejeitar'
 *              - Domínio de valores e significado de "Data de Liquidação da Baixa" (obrigatório): Data de liquidação da baixa apenas para a ação "Baixar" não baixar se não houver. Se vier a data para ação rejeitar, desconsiderar o dado passado.
 *              - Domínio de valores e significado de "Motivo da Rejeição" (não obrigatório): Motivo da rejeição apenas para a ação "Rejeitar". Se vier o motivo da rejeição para a ação baixar, é desconsiderado
 *            * Fluxo de Negócio: Trata-se de lançamentos para tentativas de cobrança EDI PAGFOR de valores a débito dos EC's, porém não houve resposta destes PAGFOR. A dívida é quitada de outra forma e agora é preciso "baixar" a pendência no sistema.
 *            * Premissa:
 *              - Clientes configurados para geracao de massa em PERF_CLIENTE_TRANSACAO
 *              - Preparacao da massa é complexa: 
 *                a) fazer ajuste negativo o EC; 
 *                b) configurar no rebatedor da CIP para não estar no rebatedor do PagFor (time marcos cabral), demora 2 dias da liquidacao, 
 *                c) a informaçao "Tipo Liquidação" com os valores 'Crédito' ou 'Débito' debito diz respeito ao 'cd_payment_category' e não o sinal do valor
 *                d) necessário cruzar com o cadastro de produto do cliente e sua respectiva de liquidacao do cliente
 *                e) necessário vincular (ec, banco, ag, conta, valor, dt_vencimento) do ajuste feito
 *                f) depende da configuração de pagfor saber quando o arquivo PAGFOR deve sair
 *                g) oportunidade de procurar na base massa antiga "Operacoes >> Regularizacoes >> Debito ao cliente sem retorno"
 *              - Em 06/02/2019, Eder Ribeiro/Stefanini, passou a query base do formulario do sistema STAR :: Operações >> Regularizações financeiras >> Debitos ao cliente sem retorno
 */
 
 SELECT 
        TO_CHAR(p.nu_customer)                             AS "Cliente", 
        'Crédito'                                          AS "Tipo Liquidacao", 
        p.cd_bank                                          AS "Banco", 
        REPLACE(p.nu_agency, '.', '')                      AS "Agencia", 
        REPLACE(REPLACE(p.nu_current_account || '- ' || p.nu_digit_control_account,' ',''), '.', '')
                                                           AS "Conta", 
        REPLACE( TO_CHAR( ABS(p.vl_payment_net), '999999999999,99'), ' ', '' )
                                                           AS "Valor", 
        TO_CHAR(p.dt_confirmation_settlement,'DD/MM/YYYY') AS "Data vencimento", 
        'Baixar'                                           AS "Acao(Baixar, Rejeitar)", 
        TO_CHAR(p.dt_confirmation_settlement,'DD/MM/YYYY') AS "Data de Liquidacao da Baixa", 
        'STRESS TEST'                                      AS "Motivo da Rejeicao"
        /* QueryOriginal: p.nu_customer, p.dt_return_deposit, p.in_settlement_type, p.cd_bank, p.nu_agency, p.nu_current_account, p.nu_digit_control_account, p.vl_payment_net, p.dt_confirmation_settlement, PC.dt_creation, p.qt_send, p.nu_trace, p.nu_mod_customer, p.nm_dba, p.cd_status, p.dt_transmission_date */
 FROM   TBSETR_SETTLEMENT_PAYMENT p
 LEFT   JOIN TBSHRR_REGISTRATION_BATCH PC
 ON     PC.nu_file_id = p.nu_output_file_id
 INNER  JOIN TBPRDR_PRODUCT prdr
 ON     prdr.cd_product = p.cd_product
 INNER  JOIN TBPRDR_CARD_ASSOCIATION prdrca
 ON     prdrca.cd_card_association = prdr.cd_card_association
 WHERE  NOT EXISTS
        (
          SELECT pR.NU_TRACE
          FROM   TBSETR_PAYMENT_PROCESS_REQ pR
          WHERE  p.NU_TRACE = pR.NU_TRACE
          AND    p.NU_CUSTOMER = pR.NU_CUSTOMER
          AND    p.NU_MOD_CUSTOMER = pR.NU_MOD_CUSTOMER
          AND    pR.Cd_Status_Request in (1,2)
        )
 AND 
        (
          (
            p.DT_SETTLEMENT < TRUNC(SYSDATE) - 120 
            AND p.cd_bank <> 341
          )
          OR
          (
            p.DT_SETTLEMENT < TRUNC(SYSDATE) - 120 
            AND p.cd_bank = 341 AND p.CD_PAGFOR_FILE_TYPE = 'D'
          )
        )
 AND p.cd_pagfor_file_type = 'D'
 AND p.cd_status in ('O')
 AND (1 = 1 OR p.cd_bank = null)
 AND (1 = 1 OR p.nu_customer = null)
 AND    EXISTS 
        ( 
          SELECT 'X' FROM PERFSTAR.PERF_CLIENTE_TRANSACAO perf WHERE  perf.nu_customer = p.nu_customer 
        )
 AND    prdr.cd_payment_category <> 2 /* 2 - Débito */
 AND    prdr.cd_payment_method <> 2 /* 2 - Parcelado loja */
 AND    ROWNUM <= 200000
 AND    ROWNUM <= 1000 /* e-mail Nilton Amancio 22/02 */
 ORDER  BY p.nu_customer
