/* 
 * Filename : 09 - STD-FRONTEND - CancelamentoDeVenda.sql
 * Author   : josemarsilva@inmetrics.com.br
 * Date     : 2019-02-14
 * Premissas: 
 *            * Layout obtido em 01/02/2019 com Danileo Morais da Yaman:
 *              - Formato: (.xlsx)
 *              - Colunas: 
 *                ESTABELECIMENTO | LOTE | DT DEPÓSITO | CARTÃO / XID | DT VENDA | VL VENDA | VL CANCELAR | AUT. | MOTIVO |
 *                - Domínio de valores e significado de "ESTABELECIMENTO" (obrigatório):
 *                - Domínio de valores e significado de "LOTE" (não obrigatório): Data da Venda
 *                - Domínio de valores e significado de "DT DEPÓSITO" (não obrigatório): 
 *                - Domínio de valores e significado de "CARTÃO / XID" (não obrigatório):
 *                - Domínio de valores e significado de "DT VENDA" (obrigatório): 
 *                - Domínio de valores e significado de "VL VENDA" (obrigatório):
 *                - Domínio de valores e significado de "VL CANCELAR" (obrigatório):
 *              - Regras:
 *                - EC's reservados para StressTest, transacionados pelo GeradorMassa ( dt_batch, nu_load_file)
 *                - Partição: | 4,6,8        | Massivo            | Cancelamento/Reversao |
 *                - EC's em convivencia financeira
 *              - Exemplo de massa:
 *                ESTABELECIMENTO | LOTE     | DT DEPÓSITO | CARTÃO / XID     | DT VENDA   | VL VENDA | VL CANCELAR | AUT.   | MOTIVO |
 *                1098932916      |          | 20/12/17    | 446696******2012 | 12/07/2017 | 499,36   | 499,36      | 22509  |        |
 *                1062703631      |          | 20/12/17    | 497040******0914 | 19/07/2017 | 850,88   | 850,88      | 344511 |        |
 *                1084591410      |          | 20/12/17    | 400178******2148 | 12/09/2017 | 19,90    | 19,90       | 137135 |        |
 *                1035143841      |          | 20/12/17    | 498408******3854 | 12/07/2017 | 691,02   | 691,02      | 178927 |        |
 *                1066144602      |          | 20/12/17    | 410863******4853 | 11/04/2017 | 544,41   | 544,41      | 172677 |        |
 *
 *            * Fluxo de Negócio: Cancelar uma venda
 *            * Premissa:
 *              - Importante que o esta planilha tem uma "carcaça" que tem títulos de colunas iniciando na linha 2-11 e não pode ser desrespeitado. Sera preciso exportar o resultado da query em outra planilha e depois copiar e colar a partir da celula A3
 */
 
 SELECT /*+ PARALLEL 8 */ 
        DISTINCT TO_CHAR(ct.nu_customer)             AS "ESTABELECIMENTO",
        ''                                           AS "LOTE",
        TO_CHAR(ct.dt_transaction,'DD/MM/YYYY')      AS "DT DEPOSITO",
        ''                                           AS "CARTAO / XID",
        TO_CHAR(ct.dt_transaction,'DD/MM/YYYY')      AS "DT VENDA",
        REPLACE( REPLACE( TO_CHAR(ct.vl_transaction,  '999999999.99'), ' ', '' ), '.', ',' )
                                                     AS "VL VENDA",
        REPLACE( REPLACE( TO_CHAR(ct.vl_transaction/5,'999999999.99'), ' ', '' ), '.', ',' )
                                                     AS "VL_CANCELAR",
        ct.nu_authorization                          AS "AUTH",
        'STRESS TEST'                                AS "MOTIVO"
 FROM   TBCAPR_CAPTURED_TRANSACTION ct,
        TBPRDR_PRODUCT p,
        TBPRDR_CARD_ASSOCIATION ca,
        TBPRDR_PAYMENT_CATEGORY pc,
        TBPRDR_PAYMENT_METHOD pm,
        TBSETR_SETTLEMENT_TRANSACTION st
 WHERE  1=1 
        /* Join */ 
 AND    p.cd_product = ct.cd_product
 AND    ca.cd_card_association = p.cd_card_association
 AND    pc.cd_payment_category = p.cd_payment_category
 AND    pm.cd_payment_method = p.cd_payment_method
 AND    st.dt_batch = ct.dt_batch
 AND    st.nu_mod_customer = ct.nu_mod_customer
 AND    st.nu_customer = ct.nu_customer
 AND    st.nu_transaction_id = ct.nu_transaction_id
        /* Condition */ 
 AND    ct.dt_batch = TO_DATE('28/02/2019','DD/MM/YYYY')
 AND    ct.nu_load_file_id = 12864870 
 AND    st.vl_gross_available_amount = st.vl_transaction_amount
        /* Reuniao 22/02/2019 Nilton/Carina/Victor/Josemar */
 /* AND    p.cd_payment_category <> 2 */ /* 2 - Débito */
 /* AND    p.cd_payment_method <> 2   */ /* 2 - Parcelado loja */
 AND    MOD( ct.nu_customer, 10) IN ( 4,6,8 )
 AND    EXISTS
        (
          SELECT 'X' FROM PERFSTAR.PERF_CLIENTE_TRANSACAO perf WHERE  perf.nu_customer = ct.nu_customer
        )
 AND    EXISTS
        (
         SELECT 'X'
         FROM   CNV.TBCNVR_STCO_CVNC_EC sce
         WHERE  sce.nu_customer = ct.nu_customer
         AND    sce.cd_stco_cvnc = 'S'
        )
 AND    ROWNUM <= 200000
 AND    ROWNUM <= 10000 /* e-mail Nilton Amancio 22/02 */
        /* Order by */
 ORDER  BY ct.nu_customer
