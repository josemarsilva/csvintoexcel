/* 
 * Filename : 07 - STD-FRONTEND - ReprocessamentoDeVendas
 * Author   : josemarsilva@inmetrics.com.br
 * Date     : 2019-02-14
 * Premissas: 
 *            * Layout obtido em 07/11/2018:
 *              - Formato: (.xlsx)
 *              - Colunas: Tipo de Reprocessamento, Cliente, Código de autorização, Data da Autorização, Valor da autorização, N° do cartão aberto, Tipo de pagamento, Parcelado banco, Quantidade de parcelas, TID Visa, Terminal, NSU, Comentários
 *              - Regras:
 *                - EC's reservados para StressTest
 *                - EC's numeros positivos
 *                + Tipo 2:
 *                  - "Cliente": EC's reservados StressTest
 *                  - "Codigo de autorizacao": randomico 6 posicoes
 *                  - "Tipo de Pagamento": código do produto bandeiras "HIPER" e "AMEX" porque liquidam no STAR
 *                  - "Parcelado Banco": 'N' - Não e 'S' para Sim
 *                  - "Qtde Parcelas": (0 para a vista, ou numero da parcela)
 *                  - "Numero de Terminal": terminal ativo para o EC buscar no cadastro
 *                  - "NSU": numero randomico de 6 posicoes)
 *                  - "Comentario": Fixo 'Stress Test'
 *                  - Atenção: A geração de massa do tipo '2' implicara na necessita de construir um novo arquivo de massa para submeter a aprovação no Control Tower
 *              - Exemplo de massa:
 *                | Tipo de Reprocessamento | Cliente    | Código de autorização | Data da Autorização | Valor da autorização | N° do cartão aberto | Tipo de pagamento | Parcelado banco | Quantidade de parcelas | TID Visa | Terminal | NSU | Comentários     |
 *                | 1                       | 2004242692 | 200100                | 28/03/2018          | R$10,00              | 4539815282900060    |                   |                 |                        |          |          |     |                 |
 *                | 2                       | 2004242692 | 200100                | 28/03/2018          | R$10,00              | 4539815282900060    | 43                | N               | 2                      | 44445480 | 391727   |     | Grandes cadeias |
 *            * Fluxo de Negócio: Fluxo de Negócio: Divide-se em 2 tipos a saber: 7.1) REPROCESSAMENTO; 7.2) REENTRADA. Cada tipo torna a massa mais simples ou complexa
 *              - Tipo reprocessamento, é preciso que exista uma transação com rejeição de captura com os mesmos atributos de ( Cliente, Cod Autorizacao, Dt Autorizacao, Valor, No. Aberto Cartao ) o que torna a massa mais complicada, pois antes executar é preciso ter uma rejeição com aquelas caracteristicas
 *              - Tipo reentrada, é semelhante a uma captura manual, porém é preciso informar mais detalhes da venda tais como "tipo de pagamento", parcelas, terminal, NSU, etc. Todas informações possiveis de serem retiradas de query, sendo necessário tomar o cuidado de não duplicar NSU e respeitar os produtos do EC
 *              - "1 - REPROCESSAMENTO, o SSB deverá chamar o serviço do control tower para aprovação e depois chamar serviço de Settlement  2 - REENTRADA, o SSB deverá chamar apenas o serviço de Settlement"
 *            * Query:
 *            * [TO-DO] Requisito implementar apenas o tipo 2 porque o tipo 1 é uma massa complexa
 *            * [TO-DO] Tipo 2: Necessita de um novo arquivo de massa, Requisito tipo 2 precisa de aprovação no Control Tower - Nilton ficou de enviar o endereco do servidor SQLSERVER, usario, senha e query base
 */
 
 SELECT '2'                                           AS "Tipo de Reprocessamento",
        TO_CHAR(m.nu_customer)                        AS "Cliente",
        TO_CHAR( TRUNC(DBMS_RANDOM.VALUE(1,999999),0), '000000' )
                                                      AS "Código de Autorizacao",
        TO_CHAR(SYSDATE-1,'dd/mm/yyyy')
                                                      AS "Data da Autorizacao",
        '10,00'                                       AS "Valor da autorizacao",
        '4539815282900060'                            AS "No do cartao aberto", 
        TO_CHAR( cpm.cd_product )                     AS "Tipo de pagamento",
        DECODE(p.cd_payment_method, 3 /* 3 - Parcelado banco */, 'S', 'N' )
                                                      AS "Parcelado Banco",
        DECODE(p.cd_payment_method, 
          2, '2', /* Parcelado loja  */ 
          3, '3', /* Parcelado banco */
          '0' )                                        AS "Quantidade parcelas",
        ''                                            AS "TID Visa",
        TO_CHAR 
        ((
          SELECT MAX( lt.nu_terminal_id )
          FROM   TBCTMR_GEOGR_ADDRESS ga,
                 TBCTMR_LOGIC_TERMINAL lt
          WHERE  lt.cd_address = ga.cd_address
          AND    ga.nu_customer = m.nu_customer
          AND    lt.dt_end_operation < TRUNC(SYSDATE)
        ))                                            AS "Terminal",
        TO_CHAR( TRUNC(DBMS_RANDOM.VALUE(1,999999),0), '000000' )
                                                      AS "NSU",
        'StressTest'                                  AS "Comentarios"
 FROM   TBCTMR_MERCHANT            m,
        TBCTMR_CONFIG_PMT_MERCHANT cpm,
        TBPRDR_PRODUCT             p
 WHERE  1=1 
        /* Join */ 
 AND    cpm.dt_config_reference = TRUNC(SYSDATE)
 AND    cpm.nu_customer = m.nu_customer
 AND    p.cd_product = cpm.cd_product
        /* Condition */ 
 AND    m.nu_customer > 0
 AND    p.cd_card_association IN ( 3 /* AMEX */,  40 /* HIPERCARD */ )
 AND    EXISTS
        (
          SELECT 'X' FROM PERFSTAR.PERF_CLIENTE_TRANSACAO perf WHERE  perf.nu_customer = m.nu_customer
        )
 AND    ROWNUM <= 200000
 AND    ROWNUM <= 10000 /* e-mail Nilton Amancio 22/02 */
        /* Order by */
 ORDER  BY m.nu_customer
